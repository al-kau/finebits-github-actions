################################################################################
#                                                                              #
#   Copyright 2024 Finebits (https://finebits.com)                             #
#                                                                              #
#   Licensed under the Apache License, Version 2.0 (the "License");            #
#   you may not use this file except in compliance with the License.           #
#   You may obtain a copy of the License at                                    #
#                                                                              #
#       http://www.apache.org/licenses/LICENSE-2.0                             #
#                                                                              #
#   Unless required by applicable law or agreed to in writing, software        #
#   distributed under the License is distributed on an "AS IS" BASIS,          #
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.   #
#   See the License for the specific language governing permissions and        #
#   limitations under the License.                                             #
#                                                                              #
################################################################################

name: Check Package Actions

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
      - release/**
  pull_request:
    branches:
      - main
      - develop
      - release/**
      
env:
  test-project: 'package/.test/Finebits.Package.Helloworld/Finebits.Package.Helloworld.csproj'
  publish-options: '--configuration "release" --framework "net8.0" --self-contained --property:DebugSymbols=false --property:DebugType=None --property:GenerateDocumentationFile=fasle --property:Version="1.0.0.0" --property:PublishAot=false --property:PublishSingleFile=true'
  dotnet-version: 8.x

jobs:

  check-all:

    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Print bash environment values
      shell: bash
      run: printenv

    - name: Print powershell environment values
      shell: pwsh
      run: Get-ChildItem "env:"

  check-linux:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Install dotnet
      uses: actions/setup-dotnet@4d6c8fcf3c8f7a60068d26b594648e99df24cee3 # v4.0.0
      with:
        dotnet-version: ${{ env.dotnet-version }}

    - name: Run './package/appimage/setup' action
      id: setup-appimagekit
      uses: ./package/appimage/setup

    - name: Check './package/appimage/setup' action
      shell: bash
      run: |
        appimagekit="${{ steps.setup-appimagekit.outputs.appimagekit }}"

        if ( ! command -v "$appimagekit" ); then
          echo "::error::'$appimagekit' command not found"
        fi

    - name: Pre-Run './package/appimage/pack' [with runtime x86_x64] action  
      shell: bash
      run: |
        dotnet publish ${{ env.test-project }} --output "./.test/bin/linux-x64" --runtime "linux-x64" ${{ env.publish-options}}

    - name: Pre-Run './package/appimage/pack' [with runtime aarch64] action  
      shell: bash
      run: |
        dotnet publish ${{ env.test-project }} --output "./.test/bin/linux-arm64" --runtime "linux-arm64" ${{ env.publish-options}}

    - name: Print bash environment values
      shell: bash
      run: printenv

    - name: Print powershell environment values
      shell: pwsh
      run: Get-ChildItem "env:"
